<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Separate 2</title>

  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="style.css" />



</head>
<body>



<h2>Check the Weather</h2>
<div class="button-container">
  <button onclick="selectTown('Cornwall')">Cornwall</button>
  <button onclick="selectTown('London')">London</button>
  <button onclick="selectTown('Bath')">Bath</button>
  <button onclick="selectTown('York')">York</button>
  <button onclick="selectTown('Edinburgh')">Edinburgh</button>
</div>


<div id="map"></div>

<div id="modal" class="modal" onclick="closeModal()">
  <div id="modal-content" class="modal-content" onclick="event.stopPropagation()">
    <h3 id="city-name"></h3>
    <img id="weather-img" class="weather-img" src="" alt="Weather Icon" />
    <p id="weather-info"></p>
    <button class="close-btn" onclick="closeModal()">Close</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
let map, clusters, locations, allMarkers = {};
let lastSelectedMarker = null;
let lastCircle = null;

function getWeather(city) {
  fetch(`weather.php?city=${encodeURIComponent(city)}`)
    .then(response => response.json())
    .then(data => {
      const modal = document.getElementById('modal');
      const modalContent = document.getElementById('modal-content');
      const cityName = document.getElementById('city-name');
      const weatherImg = document.getElementById('weather-img');
      const weatherInfo = document.getElementById('weather-info');

      if (data.error || data.cod !== 200) {
        cityName.innerText = city;
        weatherInfo.innerText = "Unable to retrieve weather.";
        weatherImg.src = "https://img.icons8.com/emoji/96/question-mark.png";
        modalContent.className = "modal-content";
        modal.classList.add('active');
        return;
      }

      const weatherMain = data.weather[0].main.toLowerCase();
      let iconUrl = "";
      let bgClass = "";

      if (weatherMain.includes("cloud")) {
        iconUrl = "https://img.icons8.com/fluency/96/cloud.png";
        bgClass = "cloudy";
      } else if (weatherMain.includes("clear") || weatherMain.includes("sun")) {
        iconUrl = "https://img.icons8.com/emoji/96/sun-emoji.png";
        bgClass = "sunny";
      } else if (weatherMain.includes("rain")) {
        iconUrl = "https://img.icons8.com/fluency/96/rain.png";
        bgClass = "rainy";
      } else {
        iconUrl = "https://img.icons8.com/emoji/96/question-mark.png";
        bgClass = "";
      }

      cityName.innerText = city;
      weatherImg.src = iconUrl;
      weatherInfo.innerText = `
Temperature: ${data.main.temp}°C
Weather: ${data.weather[0].main}
Description: ${data.weather[0].description}
Wind: ${data.wind.speed} m/s
      `;
      modalContent.className = `modal-content ${bgClass}`;
      modal.classList.add('active');
    })
    .catch(error => {
      console.error("Error:", error);
      document.getElementById('city-name').innerText = city;
      document.getElementById('weather-info').innerText = "Error fetching weather.";
      document.getElementById('weather-img').src = "https://img.icons8.com/emoji/96/question-mark.png";
      document.getElementById('modal').classList.add('active');
    });
}

function closeModal() {
  document.getElementById('modal').classList.remove('active');
}

function clearSelection() {
  if (lastSelectedMarker) {
    lastSelectedMarker._icon.classList.remove('selected');
    lastSelectedMarker = null;
  }
  if (lastCircle) {
    map.removeLayer(lastCircle);
    lastCircle = null;
  }
}

function drawBorder(latlng) {
  if (lastCircle) map.removeLayer(lastCircle);
  lastCircle = L.circle(latlng, {
    radius: 10000,
    color: 'black',
    weight: 3,
    fillOpacity: 0,
    dashArray: '5,10'
  }).addTo(map);
}


function selectTown(name) {
  getWeather(name);
}

document.addEventListener('DOMContentLoaded', () => {
  map = L.map('map').setView([54.5, -3.5], 5.7);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  clusters = {
    south: L.markerClusterGroup({ chunkedLoading: true }),
    midlands: L.markerClusterGroup({ chunkedLoading: true }),
    north: L.markerClusterGroup({ chunkedLoading: true }),
  };

  locations = {
    south: [
      { coords: [50.2653, -5.0527], name: 'Cornwall' },
      { coords: [51.3758, -2.3599], name: 'Bath' },
      { coords: [51.5072, -0.1276], name: 'London' },
    ],
    midlands: [
      { coords: [53.9590, -1.0815], name: 'York' },
      { coords: [53.3811, -1.4701], name: 'Sheffield' },
      { coords: [52.4862, -1.8904], name: 'Birmingham' },
    ],
    north: [
      { coords: [55.9533, -3.1883], name: 'Edinburgh' },
      { coords: [56.4907, -4.2026], name: 'Inverness' },
      { coords: [55.8642, -4.2518], name: 'Glasgow' },
    ],
  };

  for (const [region, places] of Object.entries(locations)) {
    places.forEach(({ coords, name }) => {
      const marker = L.marker(coords, {
        icon: L.divIcon({
          className: 'custom-marker',
          html: `<div class="marker-dot"></div>`,
          iconSize: [20, 20],
          iconAnchor: [10, 10],
        }),
      });

      marker.on('click', () => {
        clearSelection();
        if (marker._icon) {
          marker._icon.classList.add('selected');
          lastSelectedMarker = marker;
        }

        drawBorder(marker.getLatLng());
        map.setView(marker.getLatLng(), 11);

        marker.bindPopup(`<b>${name}</b><br/>Loading...`).openPopup();

        fetch(`weather.php?city=${encodeURIComponent(name)}`)
          .then(res => res.json())
          .then(data => {
            if (data.cod !== 200) {
              marker.bindPopup(`<b>${name}</b><br/>Weather unavailable.`).openPopup();
              return;
            }

            const popupContent = `
              <b>${name}</b><br/>
              Temp: ${data.main.temp}°C<br/>
              Weather: ${data.weather[0].main}<br/>
              Wind: ${data.wind.speed} m/s
            `;
            marker.bindPopup(popupContent).openPopup();
          })
          .catch(() => {
            marker.bindPopup(`<b>${name}</b><br/>Error loading data.`).openPopup();
          });
      });

      allMarkers[name] = marker;
      clusters[region].addLayer(marker);
    });
    map.addLayer(clusters[region]);
  }

  map.on('click', () => {
    clearSelection();
  });
});
</script>
</body>
</html>
